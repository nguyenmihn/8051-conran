#include <at89x51.h>

#define COMMONPORTS		P0
sbit SRCLK = P3^6;
sbit RCLK = P3^5;
sbit SER = P3^4;
int food = 0;
int ran[20] = {1,0};
int i,k,duoi=-1,j,l;
int length_ran = 2;
int phim;
int option = 0;
extern int rand(void);
unsigned char code TAB2[8]  = {0x7f,0xbf,0xdf,0xef,0xf7,0xfb,0xfd,0xfe};
unsigned char code CHARCODE[64][8]=
{
{0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x20,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x10,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x08,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x04,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x40,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x20,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x08,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x04,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x20,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x08,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x04,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x20,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x10,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x08,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x04,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x40,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x20,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x08,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x04,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x10,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x08,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x20},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x10},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x08},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02},
{0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01},
};

int key;
int keypad[4][4]={{0,1100,1200,1300},
									{1,2,3,10},
									{6,5,4,10},
									{7,8,9,10},
									};

void delay(int cnt)
{
	while(cnt--)
	{}
}

//quet ban phim
int quetphim()
{
int c, r;
P1=0x0F;
delay(2);
	if(P1!=0x0F)   
	{
		for(r=0;r<4;r++)                    
		{
			P1=~(0x01<<(4+r));
			delay(2);
			for(c=0;c<4;c++)         
			{
				if((P1&(0x01<<c))==0)
				{
					while((P1&(0x01<<c))==0) {};
						P1=0x0F;
					return keypad[r][3-c]; 
			}
			}
		}
	}
P1=0x0F;
	return 1400;
}


void Hc595SendByte(unsigned char dat)
{
	unsigned char a;
	SRCLK=0;
	RCLK=0;
	for(a=0;a<8;a++)
	{
		SER=dat>>7;
		dat<<=1;
		
		SRCLK=1;
		delay(2);
		delay(2);
		SRCLK=0;	
	}

	RCLK=1;
	delay(2);
	delay(2);
	RCLK=0;
}

void update(int ran[], int length_ran){
	// cap nhat trang thai cua ran
	unsigned int i ;
	for(i= length_ran-1; i>0; i--){
		ran[i] = ran[i-1];
	}
}

// hien thi ran
void hienthi(int length_ran, int ran[]){
	unsigned char tab,x_snake;
	unsigned int i,j;
	for(i = 0; i<1; i++){
		for(j = 0; j<length_ran; j++){
			x_snake = ran[j]/8;
			for(tab=0;tab<1;tab++)
			{
				Hc595SendByte(0x00);
				COMMONPORTS	= TAB2[x_snake];	
				Hc595SendByte((CHARCODE[ran[j]][x_snake]));
				delay(10);		
			}
		}
	}
}

// hien thi vat can
void hienthivatcan(){
	unsigned char tab,x_vatcan;
	unsigned int i;
	x_vatcan = 4;
	for(i = 0; i<3; i++){
			for(tab=0;tab<1;tab++)
			{
				Hc595SendByte(0x00);
				COMMONPORTS	= TAB2[x_vatcan];	
				Hc595SendByte((CHARCODE[0xff][x_vatcan]));
				delay(3);		
			}
	}
}

//hien thi thuc an
void hienthifood(int food){
	unsigned char tab,x_food;
	unsigned int i;
	x_food = food/8;
	for(i = 0; i<3; i++){
			for(tab=0;tab<1;tab++)
			{
				Hc595SendByte(0x00);
				COMMONPORTS	= TAB2[x_food];	
				Hc595SendByte((CHARCODE[food][x_food]));
				delay(3);		
			}
	}
}

int main()
{
	food = rand() % 64;
	key = 10;
	
	while (1)
	{
		// chon che do cho game
		if(P3_3 == 0){
			option = 1 ;
			delay(100);
		}
		if (P3_2 == 0){
			option = 0 ;
			delay(100);
		}
		if (P3_0 == 0){
			option = 2 ;
			delay(100);
		}
		duoi = ran[length_ran-1];//gan gia tri duoi
		phim = quetphim();
		if(phim == 2 && key!=6){
			key = 4;
			delay(100);
		}
		if(phim == 8 && key!=4){
			key = 6; 
			delay(100);
		}
		if(phim == 4 && key!=8){
			key = 2;
			delay(100);
		}
		if(phim == 6 && key!=2){
			key = 8; 
			delay(100);
		}
		
		// cho ran di xuyen tuong hoac dung tuong chet
		if(option==0 || option==2){ //che do di xuyen tuong hoac vat can
			switch (key)
			{
			case 4://xuong
				update(ran,length_ran);
				if((ran[0]+1)%8 == 0) { ran[0] = ran[0]-7; delay(100);}
				else {ran[0]++;delay(100);}
				delay(2);
				break;
			case 6://len
				update(ran,length_ran);
				if(ran[0]%8 == 0) { ran[0] = ran[0]+7; delay(100);}
				else {ran[0]--;delay(100);}
				delay(2);
				break;
			case 2://phai
				update(ran,length_ran);
				if(ran[0]/8 == 7) { ran[0] = ran[0]-56; delay(100);}
				else {ran[0] += 8;delay(100);}
				delay(2);
				break;
			case 8://trai
				update(ran,length_ran);
				if(ran[0]/8 == 0) { ran[0] = ran[0]+56; delay(100);}
				else {ran[0] -= 8;delay(100);}
				delay(2);
				break;
			}
	}
		else if(option==1){// dung tuong thi se ket thuc tro choi
			switch (key)
			{
			case 4://xuong
				update(ran,length_ran);
				if((ran[0]+1)%8 == 0) { return 0;}
				else {ran[0]++;delay(100);}
				delay(2);
				break;
			case 6://len
				update(ran,length_ran);
				if(ran[0]%8 == 0) { return 0;}
				else {ran[0]--;delay(100);}
				delay(2);
				break;
			case 2://phai
				update(ran,length_ran);
				if(ran[0]/8 == 7) { return 0;}
				else {ran[0] += 8;delay(100);}
				delay(2);
				break;
			case 8://trai
				update(ran,length_ran);
				if(ran[0]/8 == 0) { return 0;}
				else {ran[0] -= 8;delay(100);}
				delay(2);
				break;
			}
	}
		//trong che do di xuyen tuong
		if(option == 2){
			//tao thuc an moi neu nhu thuc an trung voi vi tri
			while(food >= 32 && food <= 39){
				food = rand() % 64;
			}
			//neu ran dung tuong se chet
			if(ran[0] >= 32 && ran[0] <= 39){
				return 0;
			}
		}
		
		// kiem tra xem ran co cham thuc an hay khong
		if (ran[0] == food) {
      // Tang kích thuoc con ran
			length_ran = length_ran + 1;
			//gan duoi con ran
			ran[length_ran-1] = duoi;
      // Tao mot thuc an moi
      food = rand() % 64;
    }
		// kiem tra xem ran co cam vao chinh no hay khong
		for(l = 1; l < length_ran; l++){
			if(ran[0] == ran[l]) {return 0;}
		}
		
		// Hien thi ran
		// kiem tra xem o che do nao de hien thi
		if(option == 2){
			for (k = 0; k < 15; k++){
					hienthi(length_ran,ran); 
					delay(2);
					hienthifood(food);
					delay(2);
					hienthivatcan();
					delay(2);
			}
		}
		else{
			for (k = 0; k < 15; k++){
					hienthi(length_ran,ran); 
					delay(2);
					hienthifood(food);
					delay(2);
			}
		}
		delay(100);
	}
}